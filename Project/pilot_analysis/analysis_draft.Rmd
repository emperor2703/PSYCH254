<style>div.comment {color:blue}</style>
---
title: "Analysis of Pilot Data"
output: html_document
---
```{r import_libraries, echo = FALSE}
library("jsonlite")
library("tidyr")
library("dplyr")
library("ggplot2")
library("lme4")
library("lmerTest")

sem <- function(x) {sd(x) / sqrt(length(x))}
ci95 <- function(x) {sem(x) * 1.96}
```

Reported here are the results from 5 pilot subjects collected on Mechanical Turk. 3 subjects were random assigned to the moral condition and 2 to the immoral condition. Subjects in both conditions read about Justin, who decided quickly, and Nate, who decided slowly. (2 x 2 design with Morality as a between-subjects factor and Speed as a within-subjects factor)   

```{r First_try_at_data_wrangling, echo = FALSE}
# Get all file names in data_directory
# file_names = file.path("../pilot_data",list.files("../pilot_data"))

# # run for loop to load all files
# nSub = length(file_names)
# d0 = NULL;
# 
# for (i in 1:nSub){
#   temp = data.frame(fromJSON(file_names[i]))
#   temp$answer.condition = temp$answer.condition[7]
#   temp$SubID = i;
#   d0 = bind_rows(d0,temp)
# }
# # Data Wrangling
# d0 = select(d0,SubID,answer.responses,answer.condition) %>%
#   filter(answer.responses != "NA")
```

The first order of business is to convert the JSON data into a more suitable format for R. 

```{r compile_data_second_version}
# Get all file names in data_directory
file_names = file.path("../bothpilotdata",list.files("../bothpilotdata"))

nSub = length(file_names)
d0 = NULL;

for (i in 1:nSub){
  temp = fromJSON(file_names[i])
  # Ugly data-wrangling
  d_temp = NULL;
  d_temp$SubID = rep(i,2)
  d_temp$Decision = rep(temp$answer$condition[7],2)
  d_temp$Speed = c("Quick","Slow")
  d_temp$MC1 = c(substr(temp$answer$responses[2],7,7),substr(temp$answer$responses[2],14,14))
  d_temp$MC2 = c(substr(temp$answer$responses[5],7,7),substr(temp$answer$responses[5],14,14))
  d_temp$C1 = c(substr(temp$answer$responses[3],7,7),substr(temp$answer$responses[4],7,7))
  d_temp$C2 = c(substr(temp$answer$responses[3],14,14),substr(temp$answer$responses[4],14,14))
  d_temp$C3 = c(substr(temp$answer$responses[3],21,21),substr(temp$answer$responses[4],21,21))
  d_temp$C4 = c(substr(temp$answer$responses[3],28,28),substr(temp$answer$responses[4],28,28))
  d_temp$M1 = c(substr(temp$answer$responses[3],35,35),substr(temp$answer$responses[4],35,35))
  d_temp$M2 = c(substr(temp$answer$responses[3],42,42),substr(temp$answer$responses[4],42,42))
  d_temp$M3 = c(substr(temp$answer$responses[3],49,49),substr(temp$answer$responses[4],49,49))
  d_temp$E1 = c(substr(temp$answer$responses[3],56,56),substr(temp$answer$responses[4],56,56))
  d_temp$E2 = c(substr(temp$answer$responses[3],63,63),substr(temp$answer$responses[4],63,63))
  d_temp = data.frame(d_temp)
  d0 = bind_rows(d0,d_temp)
  }

# convert values to numeric
d0[,4:14] = apply(d0[,4:14], 2, function(x) as.numeric(x));

# convert reverse coded values
d0$C1 = d0$C1 * -1 + 8;
d0$E2 = d0$E2 * -1 + 8;

# Calculate means of measures
d0 = d0 %>% mutate(C.avg = (C1 + C2 + C3 + C4) /4) %>%
  mutate(M.avg = (M1 + M2 + M3)/3) %>%
  mutate(E.avg = (E1 + E2)/2)

# Gather data into long form
d.tidy = gather(d0,"Question","Response",4:17)
d.tidy$SubID = factor(d.tidy$SubID)
head(d.tidy)
```

Now that we have the data in an appropriate format. We can proceed with our analyses.  


**Manipulation Check**  
-------------------
Immediately after reading the vignette about Justin and Nate, participants rated how quickly Justin and Nate made their decision. Participants made the ratings again at the end of the experiment. These ratings serve as our manipulation checks, to ensure that participants are aware of the speed manipulation in our experiment. 


```{r Manipulation check}
# Manipulation Check 
MC1 = d.tidy %>% filter(Question == "MC1") %>%
  group_by(Speed) %>%
  summarise(Avg = mean(Response),CI = ci95(Response))
MC1$Order = 1;

MC2 = d.tidy %>% filter(Question == "MC2") %>%
  group_by(Speed) %>%
  summarise(Avg = mean(Response),CI = ci95(Response))
MC2$Order = 2;

MC = bind_rows(MC1,MC2)

# Plot
ggplot(MC, aes(x=Speed, y=Avg)) + 
  geom_bar(stat="identity",width=0.5) +
  geom_errorbar(aes(ymax = Avg + CI, ymin= Avg - CI), width=0.15) +
  facet_grid(~ Order) + 
  ylab("How quickly was the decision made? 1 = Slow, 7 = Quick") 
```
Note: Error bars show 95% CI

Let's use a paired t-test to test if participants rated Quick Justin as acting more quickly than Slow Nate.  

```{r}
# T-test for MC 1
MC1 = d.tidy %>% filter(Question == "MC1") 
t.test(Response~Speed,MC1,paired = TRUE)

# T-test for MC 1
MC2 = d.tidy %>% filter(Question == "MC2") 
t.test(Response~Speed,MC2,paired = TRUE)
```

In the first manipulation check, participants rated Quick Justin as faster than Slow Nate (t(4) = 12.8, p < 0.001). In the second manipulation check, the quickness ratings between Justin and Nate were not significantly different (t(4) = 1.54, p < 0.001). Let's take a closer look at the data from the second manipulation check.  

```{r}
MC2
```

Subject 5 was the only subject that rated Quick Justin as slower than Slow Nate. It's likely that the subject did not follow instructions.  

We will use the manipulation checks to exclude subjects. While the original study did not exclude any subjects, we will be more stringent with the participants we include in the replication due to the heterogeneity of the sample on mechanical turk. Subjects had to rate Justin as faster than Nate on both manipulation checks to be included in the study.  

```{r}
Pass2 = spread(MC2,Speed,Response) %>%
  mutate(Pass2 = Quick > Slow)

Pass = spread(MC1,Speed,Response) %>%
  mutate(Pass1 = Quick > Slow) %>%
  select(c(SubID,Pass1)) %>% 
  left_join(Pass2,by = "SubID") %>%
  select(SubID,Pass1,Pass2) %>%
  mutate(Passed = Pass1 & Pass2)
  
included = Pass$SubID[Pass$Passed] 
  
cat(sum(Pass$Passed),paste("subjects included."),sum(!Pass$Passed),paste("subjects excluded."))
```
  

Decision X Speed Interaction
-------------------

We are now ready to examine our main effect of interest. First, let's plot mean morality ratings by Decision and Speed.

```{r}
# Exclude Subject
d.included = d.tidy %>% filter(SubID %in% included)

# Subset only the averages
d.moral = d.included %>% 
  filter(Question == "M.avg")

d.moral.summary = d.moral %>% 
  group_by(Decision,Speed) %>%
  summarize(Avg = mean(Response), CI = ci95(Response))

# Plot means by decision by speed
ggplot(d.moral.summary, aes(x=Decision,y=Avg,fill=Speed)) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymax = Avg + CI, ymin =Avg - CI), width=.p2, position=position_dodge(.9)) + ylab("Morality Ratings")
```

The plot suggests that there is a Decision X Speed interaction on Moral Evaluation. We will formally test for this interaction using a mixed anova.

```{r}
d.moral$SubID = factor(d.moral$SubID)
d.moral$Decision = factor(d.moral$Decision)

# 2x2 mixed:
# IV between: Decision
# IV within:  Speed
# DV:         Response
res1 = aov(Response ~ Decision + Speed + Decision*Speed + Error(SubID/Speed), data = d.moral)
summary(res1)
```

The main effect of Decision is marginally significant (F(1) = 12.8, p = 0.07). The targets were rated as more moral when they returned the wallets (M = 5.3, 95% CI = 0.33) than when they stole the wallets (M = 4.00, 95% CI = 0.33). There is a significant Decision x Speed interaction on moral evaluation (F(1) = 51.2, p = 0.02)). To examine this interaction further, we examined the effect of speed on moral evaluation in each  condition.  

```{r}
# Moral Decision
t.test(Response ~ Speed,d.moral[d.moral$Decision=="moral",])

# Immoral Decision
t.test(Response ~ Speed,d.moral[d.moral$Decision=="immoral",])
```

When both targets made the moral decision, Quick Justine was perceived as more moral as Slow Nate. This difference was marginally significant (t(1) = 10, p = 0.06). When both targets made the immoral decision, Quick Justin was perceived as less moral than Slow Nate, though this difference was not signficant (t(1) = -3, p = 0.2). Of course, with only 2 participants in each condition, we are grossly underpowered. Nevertheless, the difference in group means that quick decisions led to more polarized evaluations. 

Mediation Analysis
---------------
Next, we test the hypothesis that the decision x speed interaction on moral evaluation was mediated by perceived certainty in the decision. Turns out, it's not that straightforward to run a mediation analysis on within-subject designs. I will follow (what I think) the authors did in the original paper, but will also think about more elegant ways of doing this. For now, the logic is as follows:

1. Establish the relationship between Speed --> Certainty
2. Test for a Decision x Certainty interaction on Moral Evaluation
3. Convert certainty and moral evaluation to difference scores
4. Test for the effect of certainty on moral evaluation separetly for both conditions
5. See that in both simple effects analyses, there is a significant slope (i.e. significant effect of certainty), and insignificant intercept (i.e. no difference in moral evaluation between Quick Justin and Slow Nate).

First, we test to see that faster decisions were perceived as more certain. 

```{r}
d.certain = d.included %>% 
  filter(Question == "C.avg")

group_by(d.certain,Speed) %>% 
  summarize(Avg = mean(Response), CI = ci95(Response))

res2 = aov(Response ~ Decision + Speed + Error(SubID/Speed), data = d.certain)
summary(res2)
```

The quick target was perceived as more certain than the slow target (F(1) = 22.5, p = 0.02). Next we test to see if there is a Decision x Certainty Interaction on moral evaluation.

```{r}
d.certainty.moral = d.included %>% 
  filter(Question %in% c("M.avg","C.avg")) %>%
  spread(Question,Response)

d.certainty.moral$SubID = factor(d.certainty.moral$SubID)
d.certainty.moral$Decision = factor(d.certainty.moral$Decision)

res3 = lmer(M.avg ~ Decision * C.avg + (1|SubID),d.certainty.moral)
summary(res3)
```

Yes, there is a Decision X Certainty interaction on moral evaluation (b = -1.2, t(2) = -8,8, p = 0.02). 

```{r}
d_M.diff = spread(d.moral,Speed,Response) %>%
  mutate(M.diff = Quick - Slow) %>%
  select(SubID,Decision,M.diff)

d_C.diff = spread(d.certain,Speed,Response) %>%
  mutate(C.diff = Quick - Slow) %>%
  select(C.diff)

d_mediation = bind_cols(d_M.diff,d_C.diff) %>%
  select(SubID,Decision,M.diff,C.diff)

res4 = lm(M.diff ~ C.diff, d_mediation[d_mediation$Decision == "moral",])
summary(res4)




# res4 = lmer(formula = scale(M.avg,scale =F) ~ scale(C.avg, scale = F) + (1|SubID), data = d.certainty.moral[d.certainty.moral$Decision == "moral", ])
# summary(res4)
# 
# res5 = lmer(formula = scale(M.avg, scale = F) ~ C.avg + (1|SubID), data = d.certainty.moral[d.certainty.moral$Decision == "immoral", ])
# summary(res5)
```
